{% extends "base.html" %}
{% block title %}Math Games - Smart Learning Cloud{% endblock %}
{% block content %}
<div class="container">
  <div class="page-header">
    <h1>üéÆ Interactive Math Games</h1>
    <p>Learn math through fun and engaging games!</p>
  </div>

  <div class="games-container">
    <div class="game-card active" id="fractionGame">
      <h3>üçï Fraction Pizza</h3>
      <p>Learn fractions by slicing pizzas!</p>
      
      <div class="game-area">
        <div class="question-area">
          <h4 id="fractionQuestion">What fraction is shaded?</h4>
          <div class="pizza-container">
            <div class="pizza" id="pizza">
              <div class="slice"></div>
              <div class="slice"></div>
              <div class="slice"></div>
              <div class="slice"></div>
            </div>
          </div>
        </div>
        
        <div class="answer-area">
          <div class="fraction-input">
            <input type="number" id="numerator" placeholder="?" min="0" max="8">
            <div class="fraction-line">/</div>
            <input type="number" id="denominator" placeholder="?" min="1" max="8">
          </div>
          <button class="btn" onclick="checkFraction()">Check Answer</button>
        </div>
      </div>
      
      <div class="game-stats">
        <div class="stat">Score: <span id="score">0</span></div>
        <div class="stat">Streak: <span id="streak">0</span></div>
      </div>
    </div>

    <div class="game-card" id="calculatorGame">
      <h3>üßÆ Speed Calculator</h3>
      <p>Solve math problems as fast as you can!</p>
      
      <div class="game-area">
        <div class="question-area">
          <h4 id="mathQuestion">5 + 3 = ?</h4>
          <div class="timer-bar">
            <div class="timer-fill" id="timerFill"></div>
          </div>
        </div>
        
        <div class="answer-area">
          <input type="number" id="mathAnswer" placeholder="Your answer">
          <button class="btn" onclick="checkMath()">Submit</button>
        </div>
      </div>
      
      <div class="game-stats">
        <div class="stat">Score: <span id="mathScore">0</span></div>
        <div class="stat">Time: <span id="timeLeft">10</span>s</div>
      </div>
    </div>

    <div class="game-card" id="patternGame">
      <h3>üî¢ Number Patterns</h3>
      <p>Find the missing number in the sequence!</p>
      
      <div class="game-area">
        <div class="question-area">
          <h4>Complete the pattern:</h4>
          <div class="pattern-sequence" id="patternSequence">
            <span class="number">2</span>
            <span class="number">4</span>
            <span class="number">6</span>
            <span class="number missing">?</span>
            <span class="number">10</span>
          </div>
        </div>
        
        <div class="answer-area">
          <input type="number" id="patternAnswer" placeholder="Missing number">
          <button class="btn" onclick="checkPattern()">Check</button>
        </div>
      </div>
      
      <div class="game-stats">
        <div class="stat">Score: <span id="patternScore">0</span></div>
        <div class="stat">Level: <span id="patternLevel">1</span></div>
      </div>
    </div>
  </div>

  <div class="game-tabs">
    <button class="tab-btn active" onclick="switchGame('fractionGame')">üçï Fractions</button>
    <button class="tab-btn" onclick="switchGame('calculatorGame')">üßÆ Calculator</button>
    <button class="tab-btn" onclick="switchGame('patternGame')">üî¢ Patterns</button>
  </div>
</div>

<style>
.games-container {
  max-width: 600px;
  margin: 0 auto 2rem;
}

.game-card {
  background: var(--card);
  border: 1px solid var(--border);
  border-radius: 1rem;
  padding: 2rem;
  display: none;
  box-shadow: var(--shadow-md);
}

.game-card.active {
  display: block;
}

.game-card h3 {
  margin: 0 0 0.5rem 0;
  color: var(--primary);
  text-align: center;
}

.game-card p {
  text-align: center;
  color: var(--text-light);
  margin-bottom: 2rem;
}

.game-area {
  margin-bottom: 2rem;
}

.question-area {
  text-align: center;
  margin-bottom: 2rem;
}

.question-area h4 {
  color: var(--text);
  margin-bottom: 1rem;
}

.pizza-container {
  display: flex;
  justify-content: center;
  margin: 2rem 0;
}

.pizza {
  width: 200px;
  height: 200px;
  border-radius: 50%;
  background: #fbbf24;
  position: relative;
  border: 3px solid #f59e0b;
  display: grid;
  grid-template-columns: 1fr 1fr;
  grid-template-rows: 1fr 1fr;
  overflow: hidden;
}

.slice {
  background: #fbbf24;
  border: 1px solid #f59e0b;
  transition: all 0.3s ease;
}

.slice.shaded {
  background: #dc2626;
}

.fraction-input {
  display: flex;
  align-items: center;
  justify-content: center;
  gap: 0.5rem;
  margin-bottom: 1rem;
}

.fraction-input input {
  width: 60px;
  text-align: center;
  font-size: 1.5rem;
  font-weight: 600;
}

.fraction-line {
  font-size: 2rem;
  font-weight: 600;
  color: var(--text);
}

.timer-bar {
  width: 100%;
  height: 8px;
  background: var(--border);
  border-radius: 4px;
  overflow: hidden;
  margin: 1rem 0;
}

.timer-fill {
  height: 100%;
  background: var(--success);
  width: 100%;
  transition: width 0.1s linear;
}

.pattern-sequence {
  display: flex;
  justify-content: center;
  gap: 1rem;
  margin: 2rem 0;
}

.number {
  width: 50px;
  height: 50px;
  background: var(--primary);
  color: white;
  border-radius: 50%;
  display: flex;
  align-items: center;
  justify-content: center;
  font-weight: 600;
  font-size: 1.2rem;
}

.number.missing {
  background: var(--border);
  color: var(--text-light);
}

.answer-area {
  text-align: center;
}

.answer-area input {
  margin-bottom: 1rem;
  text-align: center;
  font-size: 1.2rem;
  font-weight: 600;
}

.game-stats {
  display: flex;
  justify-content: space-around;
  padding: 1rem;
  background: var(--bg);
  border-radius: 0.5rem;
  border: 1px solid var(--border);
}

.stat {
  font-weight: 600;
  color: var(--text);
}

.game-tabs {
  display: flex;
  justify-content: center;
  gap: 1rem;
  margin-top: 2rem;
}

.tab-btn {
  padding: 0.75rem 1.5rem;
  background: var(--bg);
  border: 1px solid var(--border);
  border-radius: 0.5rem;
  cursor: pointer;
  font-weight: 600;
  transition: all 0.3s ease;
}

.tab-btn:hover {
  background: var(--primary);
  color: white;
}

.tab-btn.active {
  background: var(--primary);
  color: white;
}
</style>

<script>
let gameScores = { fraction: 0, math: 0, pattern: 0 };
let gameStreaks = { fraction: 0, math: 0, pattern: 0 };
let currentFraction = { num: 2, den: 4 };
let mathTimer;
let timeLeft = 10;

function switchGame(gameId) {
  document.querySelectorAll('.game-card').forEach(card => card.classList.remove('active'));
  document.querySelectorAll('.tab-btn').forEach(btn => btn.classList.remove('active'));
  
  document.getElementById(gameId).classList.add('active');
  event.target.classList.add('active');
  
  if (gameId === 'fractionGame') generateFraction();
  if (gameId === 'calculatorGame') startMathGame();
  if (gameId === 'patternGame') generatePattern();
}

function generateFraction() {
  const denominator = Math.floor(Math.random() * 6) + 3; // 3-8
  const numerator = Math.floor(Math.random() * denominator) + 1;
  
  currentFraction = { num: numerator, den: denominator };
  
  const pizza = document.getElementById('pizza');
  pizza.innerHTML = '';
  
  for (let i = 0; i < denominator; i++) {
    const slice = document.createElement('div');
    slice.className = 'slice';
    if (i < numerator) slice.classList.add('shaded');
    pizza.appendChild(slice);
  }
  
  pizza.style.gridTemplateColumns = `repeat(${Math.ceil(Math.sqrt(denominator))}, 1fr)`;
  pizza.style.gridTemplateRows = `repeat(${Math.ceil(denominator / Math.ceil(Math.sqrt(denominator)))}, 1fr)`;
}

function checkFraction() {
  const num = parseInt(document.getElementById('numerator').value);
  const den = parseInt(document.getElementById('denominator').value);
  
  const correct = (num === currentFraction.num && den === currentFraction.den) ||
                  (num / den === currentFraction.num / currentFraction.den);
  
  if (correct) {
    gameScores.fraction += 10;
    gameStreaks.fraction++;
    document.getElementById('score').textContent = gameScores.fraction;
    document.getElementById('streak').textContent = gameStreaks.fraction;
    
    // Send to server
    fetch('/check-answer', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ answer: `${num}/${den}`, correct: `${currentFraction.num}/${currentFraction.den}` })
    });
    
    alert('üéâ Correct! Well done!');
  } else {
    gameStreaks.fraction = 0;
    document.getElementById('streak').textContent = 0;
    alert(`‚ùå Not quite! The answer was ${currentFraction.num}/${currentFraction.den}`);
  }
  
  document.getElementById('numerator').value = '';
  document.getElementById('denominator').value = '';
  generateFraction();
}

function startMathGame() {
  generateMathProblem();
  startTimer();
}

function generateMathProblem() {
  const operations = ['+', '-', '√ó'];
  const op = operations[Math.floor(Math.random() * operations.length)];
  let a = Math.floor(Math.random() * 20) + 1;
  let b = Math.floor(Math.random() * 20) + 1;
  
  if (op === '-' && a < b) [a, b] = [b, a];
  
  document.getElementById('mathQuestion').textContent = `${a} ${op} ${b} = ?`;
  
  let correct;
  switch(op) {
    case '+': correct = a + b; break;
    case '-': correct = a - b; break;
    case '√ó': correct = a * b; break;
  }
  
  document.getElementById('mathQuestion').dataset.correct = correct;
}

function checkMath() {
  const answer = parseInt(document.getElementById('mathAnswer').value);
  const correct = parseInt(document.getElementById('mathQuestion').dataset.correct);
  
  if (answer === correct) {
    gameScores.math += 10;
    document.getElementById('mathScore').textContent = gameScores.math;
    alert('üéâ Correct!');
  } else {
    alert(`‚ùå Wrong! The answer was ${correct}`);
  }
  
  document.getElementById('mathAnswer').value = '';
  generateMathProblem();
  resetTimer();
}

function startTimer() {
  timeLeft = 10;
  document.getElementById('timeLeft').textContent = timeLeft;
  document.getElementById('timerFill').style.width = '100%';
  
  mathTimer = setInterval(() => {
    timeLeft--;
    document.getElementById('timeLeft').textContent = timeLeft;
    document.getElementById('timerFill').style.width = (timeLeft / 10 * 100) + '%';
    
    if (timeLeft <= 0) {
      clearInterval(mathTimer);
      alert('‚è∞ Time up!');
      generateMathProblem();
      startTimer();
    }
  }, 1000);
}

function resetTimer() {
  clearInterval(mathTimer);
  startTimer();
}

function generatePattern() {
  const patterns = [
    { seq: [2, 4, 6, 8, 10], missing: 3, answer: 8 },
    { seq: [1, 3, 5, 7, 9], missing: 2, answer: 5 },
    { seq: [5, 10, 15, 20, 25], missing: 1, answer: 10 },
    { seq: [1, 4, 7, 10, 13], missing: 4, answer: 10 }
  ];
  
  const pattern = patterns[Math.floor(Math.random() * patterns.length)];
  const container = document.getElementById('patternSequence');
  container.innerHTML = '';
  
  pattern.seq.forEach((num, index) => {
    const span = document.createElement('span');
    span.className = 'number';
    if (index === pattern.missing) {
      span.className += ' missing';
      span.textContent = '?';
      span.dataset.answer = pattern.answer;
    } else {
      span.textContent = num;
    }
    container.appendChild(span);
  });
}

function checkPattern() {
  const answer = parseInt(document.getElementById('patternAnswer').value);
  const correct = parseInt(document.querySelector('.number.missing').dataset.answer);
  
  if (answer === correct) {
    gameScores.pattern += 15;
    document.getElementById('patternScore').textContent = gameScores.pattern;
    document.getElementById('patternLevel').textContent = Math.floor(gameScores.pattern / 50) + 1;
    alert('üéâ Excellent pattern recognition!');
  } else {
    alert(`‚ùå Not quite! The answer was ${correct}`);
  }
  
  document.getElementById('patternAnswer').value = '';
  generatePattern();
}

// Initialize first game
generateFraction();
</script>
{% endblock %}